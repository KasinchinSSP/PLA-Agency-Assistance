<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>ขอใบเสนอราคา | Phillip Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                DEFAULT: "#111827",
                50: "#f8fafc",
                100: "#f1f5f9",
                200: "#e2e8f0",
                300: "#cbd5e1",
                400: "#94a3b8",
                500: "#64748b",
                600: "#475569",
                700: "#334155",
                800: "#1f2937",
                900: "#111827",
              },
            },
          },
        },
      };
    </script>
    <style>
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
    </style>
  </head>
  <body class="bg-brand-50 text-brand-900">
    <header class="max-w-xl mx-auto px-4 pt-6 pb-2">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-2xl bg-brand-900 text-white grid place-items-center font-semibold"
        >
          PA
        </div>
        <div>
          <h1 class="text-lg font-semibold">ขอใบเสนอราคา</h1>
          <p class="text-sm text-brand-600">Card Form • Mobile-first • รายปี</p>
        </div>
        <div class="ml-auto text-xs text-brand-500" id="ref-badge" hidden></div>
      </div>
    </header>

    <!-- Progress (5 steps) -->
    <div class="max-w-xl mx-auto px-4">
      <div class="w-full bg-brand-200 rounded-full h-2 overflow-hidden">
        <div id="progress" class="h-2 bg-brand-900 w-1/4 transition-all"></div>
      </div>
      <div class="flex justify-between text-[11px] text-brand-600 mt-1">
        <span>1</span><span>2</span><span>3</span><span>4</span>
      </div>
    </div>

    <main class="max-w-xl mx-auto px-4 py-4">
      <!-- STEP 1: Gender + DOB -->
      <section id="step-1" data-step="1" class="step">
        <div class="bg-white border border-brand-200 rounded-2xl p-5 space-y-5">
          <div>
            <h2 class="text-base font-semibold mb-3">คุณเป็นเพศใด</h2>
            <div
              class="grid grid-cols-2 gap-2"
              role="group"
              aria-label="เลือกเพศ"
            >
              <button
                type="button"
                data-gender="M"
                class="gender-btn py-3 rounded-xl border border-brand-300 bg-white"
              >
                ชาย
              </button>
              <button
                type="button"
                data-gender="F"
                class="gender-btn py-3 rounded-xl border border-brand-300 bg-white"
              >
                หญิง
              </button>
            </div>
            <input type="hidden" id="insured_gender" name="insured.gender" />
            <p id="err-gender" class="text-xs text-red-600 mt-2 hidden">
              กรุณาเลือกเพศ
            </p>
          </div>

          <div class="pt-2 border-t border-brand-100">
            <h2 class="text-base font-semibold mb-3">วันเกิดของคุณ (ค.ศ.)</h2>
            <div class="grid grid-cols-3 gap-2">
              <select
                id="insured_dob_d"
                name="insured.dob.d"
                class="w-full rounded-xl border border-brand-300 p-3 bg-white"
              ></select>
              <select
                id="insured_dob_m"
                name="insured.dob.m"
                class="w-full rounded-xl border border-brand-300 p-3 bg-white"
              ></select>
              <select
                id="insured_dob_y"
                name="insured.dob.y"
                class="w-full rounded-xl border border-brand-300 p-3 bg-white"
              ></select>
            </div>
            <p class="text-xs text-brand-500 mt-2">
              ใช้ปี <b>ค.ศ.</b> เช่น 1992
            </p>
            <p id="err-dob" class="text-xs text-red-600 mt-2 hidden">
              กรุณาระบุวัน/เดือน/ปี ค.ศ. ให้ครบถ้วน
            </p>
          </div>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- STEP 2: Plan + SA + Inline Quote -->
      <section id="step-2" data-step="2" class="step hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5 space-y-4">
          <div>
            <h2 class="text-base font-semibold mb-3">เลือกแบบประกัน</h2>
            <select
              id="plan_code"
              name="plan.code"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            ></select>
            <input id="plan_name" name="plan.name" type="hidden" />
            <p id="plan-note" class="text-xs text-brand-500 mt-2"></p>
            <p id="err-plan" class="text-xs text-red-600 mt-2 hidden">
              กรุณาเลือกแบบประกัน
            </p>
          </div>

          <div>
            <h2 class="text-base font-semibold mb-3">
              จำนวนเงินเอาประกัน (บาท)
            </h2>
            <div class="flex gap-2 mb-2">
              <button
                type="button"
                id="chip-min"
                data-sa=""
                class="sa-chip px-3 py-2 rounded-full border border-brand-300 bg-white text-sm"
              >
                ขั้นต่ำ
              </button>
              <button
                type="button"
                data-sa="500000"
                class="sa-chip px-3 py-2 rounded-full border border-brand-300 bg-white text-sm"
              >
                500,000
              </button>
              <button
                type="button"
                data-sa="1000000"
                class="sa-chip px-3 py-2 rounded-full border border-brand-300 bg-white text-sm"
              >
                1,000,000
              </button>
            </div>
            <input
              id="plan_sumAssured"
              name="plan.sumAssured"
              inputmode="numeric"
              pattern="[0-9]*"
              placeholder="เช่น 1000000"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            />
            <p id="sum-hint" class="text-xs text-brand-500 mt-1"></p>
            <p id="err-sa" class="text-xs text-red-600 mt-2 hidden">
              กรุณาระบุตัวเลขทุนเอาประกัน
            </p>
          </div>

          <div
            id="quote-box"
            class="rounded-xl border border-brand-200 bg-white p-4 hidden"
          ></div>
          <p class="text-xs text-brand-500">
            ผลลัพธ์เป็นประมาณการเบื้องต้น อาจต่างจากใบเสนอราคาจริง
            ขึ้นกับเงื่อนไขการรับประกัน
          </p>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- STEP 3: Riders only -->
      <section id="step-3" data-step="3" class="step hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5 space-y-4">
          <div>
            <h3 class="text-sm font-semibold mb-2">สัญญาเพิ่มเติม</h3>
            <div
              class="flex items-center justify-between rounded-xl border border-brand-300 bg-white p-3 mb-2"
            >
              <div>
                <div class="text-sm font-medium">ADB (อุบัติเหตุ)</div>
                <div id="adb-hint" class="text-xs text-brand-500">ปิดอยู่</div>
              </div>
              <button
                type="button"
                id="adb_toggle"
                class="px-3 py-2 rounded-full border border-brand-300 bg-white text-sm"
              >
                เปิด
              </button>
              <input
                id="rider_adb_cover"
                name="rider.adb.cover"
                type="hidden"
              />
            </div>

            <label class="block text-xs mb-1">HSA – ค่าห้อง/วัน</label>
            <select
              id="rider_hsa_cover"
              name="rider.hsa.cover"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white mb-3"
            ></select>

            <label class="block text-xs mb-1">HB – เงินชดเชย/วัน</label>
            <select
              id="rider_hb_cover"
              name="rider.hb.cover"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white mb-3"
            ></select>

            <label class="block text-xs mb-1">OPD – ค่ารักษา/ครั้ง</label>
            <select
              id="rider_opd_cover"
              name="rider.opd.cover"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white mb-3"
            ></select>

            <label class="block text-xs mb-1">LT – ระยะเวลา</label>
            <select
              id="rider_lt_term"
              name="rider.lt.term"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            ></select>
          </div>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- STEP 4: Email + PDPA -->
      <section id="step-4" data-step="4" class="step hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5">
          <h2 class="text-base font-semibold mb-3">รับใบเสนอราคาทางอีเมล</h2>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div>
              <label class="block text-sm mb-2">ชื่อ (ออปชัน)</label>
              <input
                id="insured_firstName"
                name="insured.firstName"
                class="w-full rounded-xl border border-brand-300 p-3 bg-white"
              />
            </div>
            <div>
              <label class="block text-sm mb-2">นามสกุล (ออปชัน)</label>
              <input
                id="insured_lastName"
                name="insured.lastName"
                class="w-full rounded-xl border border-brand-300 p-3 bg-white"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="block text-sm mb-2"
              >อีเมล <span class="text-red-600">*</span></label
            >
            <input
              id="insured_email"
              name="insured.email"
              type="email"
              placeholder="you@example.com"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            />
            <p id="err-email" class="text-xs text-red-600 mt-1 hidden">
              กรุณากรอกอีเมลให้ถูกต้อง
            </p>
          </div>
          <div class="mb-3">
            <label class="block text-sm mb-2">เบอร์โทรศัพท์ (ออปชัน)</label>
            <input
              id="insured_phone"
              name="insured.phone"
              inputmode="tel"
              placeholder="0812345678"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            />
          </div>

          <input id="agent_ref" name="source.ref" type="hidden" />
          <input
            id="mode_option"
            name="mode.option"
            type="hidden"
            value="รายปี"
          />

          <div class="mb-3 flex items-start gap-2">
            <input
              id="consent_pdpa"
              name="consent.pdpa"
              type="checkbox"
              class="mt-1"
            />
            <label for="consent_pdpa" class="text-sm"
              >ข้าพเจ้ายินยอมให้เก็บและใช้ข้อมูลเพื่อการคำนวณเบี้ย/จัดส่งใบเสนอราคา
              และการติดต่อกลับ ตาม
              <a href="#" class="underline">นโยบายความเป็นส่วนตัว</a></label
            >
          </div>
          <p id="err-pdpa" class="text-xs text-red-600 mt-1 hidden">
            กรุณายินยอม PDPA ก่อนดำเนินการต่อ
          </p>

          <!-- Preview JSON (hidden by default; open with ?debug=1) -->
          <details
            id="preview-box"
            class="bg-white border border-brand-200 rounded-xl p-3 mt-3"
            hidden
          >
            <summary class="cursor-pointer text-sm">
              ดูข้อมูลที่จะส่ง (Preview JSON)
            </summary>
            <pre id="preview" class="text-xs mt-2 whitespace-pre-wrap"></pre>
          </details>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- Success screen -->
      <section id="step-success" class="hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5">
          <h3 class="text-lg font-semibold mb-1">ส่งคำขอเรียบร้อย 🎉</h3>
          <p class="text-sm text-brand-600">
            เราได้บันทึกข้อมูลของคุณแล้ว อีเมลใบเสนอราคาจะถูกส่งไปที่
            <span id="success-email" class="font-medium"></span>
          </p>
          <p class="text-sm text-brand-600 mt-2">
            รหัสอ้างอิง: <span id="success-lead" class="font-mono"></span>
          </p>
        </div>
      </section>
    </main>

    <!-- Sticky footer nav -->
    <footer
      class="fixed bottom-0 inset-x-0 bg-white border-t border-brand-200 pb-safe"
    >
      <div class="max-w-xl mx-auto px-4 py-3 flex gap-2">
        <button
          id="btn-back"
          class="flex-1 py-3 rounded-xl border border-brand-300 text-brand-800 bg-white"
        >
          ย้อนกลับ
        </button>
        <button
          id="btn-next"
          class="flex-1 py-3 rounded-xl bg-brand-900 text-white"
        >
          ถัดไป
        </button>
        <button
          id="btn-submit"
          class="hidden flex-1 py-3 rounded-xl bg-brand-900 text-white"
        >
          ขอใบเสนอราคา
        </button>
      </div>
    </footer>

    <script>
      (() => {
        /* ---------- Config ---------- */
        const WEBHOOK_URL =
          "https://script.google.com/macros/s/AKfycbw1DOFzsYQTa-J_SQwD_HvLxaf0wsfuGzn1lQ6rdKueEMG3xiBef_HpCRiuL3tEPxkEfw/exec"; // TODO: เปลี่ยนเป็น URL จริงเมื่อพร้อม
        const PLANS = [
          {
            code: "PLA_20_10",
            name: "Happy Protect 20/10",
            note: "ออมระยะยาว คุ้มครอง 20 ปี จ่าย 10 ปี",
          },
          {
            code: "PLA_15_10",
            name: "Happy Protect 15/10",
            note: "ออมกลาง-ยาว คุ้มครอง 15 ปี จ่าย 10 ปี",
          },
          {
            code: "PRO_10_5",
            name: "Pro Saving 10/5",
            note: "เร่งออม ระยะสั้น คุ้มครอง 10 ปี จ่าย 5 ปี",
          },
          {
            code: "RET_60",
            name: "บำนาญเกษียณ 60",
            note: "วางแผนเกษียณ รับบำนาญอายุ 60",
          },
          {
            code: "LIFE_TERM",
            name: "Life Term 20",
            note: "คุ้มครองรายได้ เบี้ยประหยัด",
          },
        ];
        const RIDER_HSA = ["", "1500/วัน", "2000/วัน", "3000/วัน"];
        const RIDER_HB = ["", "500/วัน", "1000/วัน", "1500/วัน"];
        const RIDER_OPD = ["", "500/ครั้ง", "1000/ครั้ง", "1500/ครั้ง"];
        const RIDER_LT = ["", "10 ปี", "15 ปี", "20 ปี"];
        const DS_URL = './pla_insurance.json';

        /* ---------- DOM helpers ---------- */
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => [...document.querySelectorAll(sel)];
        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
        const isEmail = (s) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s || "");
        const qs = new URLSearchParams(location.search);
        const safeRef = (s) =>
          (s || "").match(/^[A-Za-z0-9_-]{1,24}$/) ? s : "";
        const formatTHB = (n) => (Number(n) || 0).toLocaleString("th-TH");

        /* ---------- State ---------- */
        const state = {
          step: 1,
          maxStep: 4,
          adbOn: false,
          submitting: false,
          submitted: false,
          dataset: null,
          plansByKey: new Map(),
          modalFactors: { annual: 1, semiAnnual: 0.52, quarterly: 0.27, monthly: 0.09 },
          quote: null,
        };

        const setProgress = () => {
          $("#progress").style.width = (state.step / state.maxStep) * 100 + "%";
          $("#btn-back").classList.toggle("hidden", state.step === 1);
          $("#btn-next").classList.toggle("hidden", state.step === state.maxStep);
          $("#btn-submit").classList.toggle("hidden", state.step !== state.maxStep);
          updateNextState();
        };
        const updateNextState = () => {
          const btn = $("#btn-next");
          if (state.step === 2) {
            const ok = !!(state.quote && Number.isFinite(state.quote.annual));
            btn.disabled = !ok;
          } else {
            btn.disabled = false;
          }
        };
        const showStep = (i) => {
          state.step = clamp(i, 1, state.maxStep);
          $$(".step").forEach((s) => s.classList.add("hidden"));
          $(`#step-${state.step}`).classList.remove("hidden");
          $("#step-success").classList.add("hidden");
          setProgress();
          location.hash = "#/step/" + state.step;
          updatePreview();
          if (state.step === 2) { ensureDataset().then(() => { debouncedRecalc(); }); }
          if (state.step === 3) { syncADBwithSA(); }
        };

        const toggleButtons = (els, activeValue) => {
          els.forEach((btn) => {
            const on = btn.dataset.gender === activeValue;
            btn.classList.toggle("bg-brand-900", on);
            btn.classList.toggle("text-white", on);
            btn.classList.toggle("border-brand-900", on);
            btn.classList.toggle("bg-white", !on);
            btn.classList.toggle("text-brand-900", !on);
          });
        };

        const setVal = (sel, val) => { const el = $(sel); if (el) el.value = val; };

        /* ---------- Quote helpers (dataset + compute) ---------- */
        const ceilTo = (num, unit = 1) => Math.ceil(num / unit) * unit;
        const computeAgeFromDOB = (d, m, y) => {
          const today = new Date();
          let age = today.getFullYear() - y;
          const mDiff = (today.getMonth() + 1) - m;
          const dDiff = today.getDate() - d;
          if (mDiff < 0 || (mDiff === 0 && dDiff < 0)) age--;
          return age;
        };

        const ensureDataset = async () => {
          if (state.dataset) return state.dataset;
          const res = await fetch(DS_URL, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`โหลดข้อมูลไม่สำเร็จ (${res.status} ${res.statusText})`);
          const data = await res.json();
          const mf = data?.metadata?.modalFactors || data?.modalFactors;
          if (mf && typeof mf === 'object') {
            const { annual, semiAnnual, quarterly, monthly } = mf;
            if ([annual, semiAnnual, quarterly, monthly].every(x => typeof x === 'number' && x > 0)) {
              state.modalFactors = { annual, semiAnnual, quarterly, monthly };
            }
          }
          state.plansByKey.clear();
          (data.plans || data.products || []).forEach(p => {
            const key = p.planKey || p.code || p.id;
            if (key) state.plansByKey.set(key, p);
          });
          state.dataset = data;
          if (state.quote) data.quote = state.quote;
          return data;
        };

        const lookupRate = (plan, age, sexMF) => {
          if (plan.calculationType === 'fixedRatePer1000') return plan.fixedRate;
          const row = Array.isArray(plan.rates) ? plan.rates.find(r => r.age === age) : null;
          if (!row) return null;
          return sexMF === 'male' ? row.male : row.female;
        };

        const applyDiscountPerThousand = (plan, sumAssured, ratePerThousand) => {
          const ds = Array.isArray(plan.discounts) ? plan.discounts : [];
          if (!ds.length) return ratePerThousand;
          const sorted = [...ds].sort((a,b) => (a.minSum||0) - (b.minSum||0));
          let disc = 0;
          for (const d of sorted) { if (sumAssured >= (d.minSum||0)) disc = d.discountPer1000 || 0; }
          const eff = ratePerThousand - disc;
          return eff < 0 ? 0 : eff;
        };

        const computeAnnualPremium = (plan, sexMF, age, sumAssured) => {
          const minA = plan?.ageRange?.min ?? 0;
          const maxA = plan?.ageRange?.max ?? 200;
          if (age < minA || age > maxA) throw new Error(`แผนนี้รับอายุ ${minA}–${maxA} ปี`);
          const minSA = plan?.minSumAssured ?? 0;
          if (sumAssured < minSA) throw new Error(`ขั้นต่ำ ${formatTHB(minSA)} บาท`);
          const baseRate = lookupRate(plan, age, sexMF);
          if (baseRate == null) {
            const years = (plan.rates||[]).map(r=>r.age).sort((a,b)=>a-b);
            if (years.length) throw new Error(`ปีอายุที่รองรับ: ${years[0]}–${years[years.length-1]}`);
            throw new Error('ไม่พบอัตราในตาราง');
          }
          const rateEff = applyDiscountPerThousand(plan, sumAssured, baseRate);
          const annual = ceilTo((sumAssured/1000) * rateEff, 1);
          return { baseRate, rateEff, annual };
        };

        const renderQuote = ({ plan, sa, quote, error } = {}) => {
          const box = $('#quote-box');
          if (error) {
            box.classList.remove('hidden');
            box.innerHTML = `<div class="text-sm text-rose-700">${error}</div>`;
            return;
          }
          if (!quote || !Number.isFinite(quote.annual)) { box.classList.add('hidden'); box.innerHTML = ''; return; }
          box.classList.remove('hidden');
          box.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-brand-600">เบี้ยรายปี (ประมาณการ)</div>
              <div class="text-lg font-semibold">${formatTHB(quote.annual)} บาท</div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs text-brand-600">
              <div>อายุที่ใช้คำนวณ: <span class="font-medium">${quote.age} ปี</span></div>
              <div>ทุนเอาประกัน: <span class="font-medium">${formatTHB(sa)} บาท</span></div>
              <div>อัตราฐาน/1000: <span class="font-medium">${formatTHB(quote.baseRate)}</span></div>
              <div>อัตราหลังส่วนลด: <span class="font-medium">${formatTHB(quote.rateEff)}</span></div>
            </div>
          `;
        };

        const updatePlanUI = (plan) => {
          if (!plan) return;
          const min = Number(plan.minSumAssured||0);
          const chip = document.getElementById('chip-min') || document.querySelector('.sa-chip');
          if (chip) { chip.dataset.sa = String(min); chip.textContent = formatTHB(min); }
          const hint = document.getElementById('sum-hint');
          if (hint) hint.textContent = min ? `ขั้นต่ำ: ${formatTHB(min)} บาท` : '';
        };

        const debounce = (fn, wait=350) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null,args), wait); }; };
        const recalc = async () => {
          try {
            await ensureDataset();
            const planCode = $('#plan_code').value;
            const plan = state.plansByKey.get(planCode);
            updatePlanUI(plan);
            const sa = parseInt($('#plan_sumAssured').value||'', 10);
            const g = $('#insured_gender').value;
            const sexMF = g === 'M' ? 'male' : (g === 'F' ? 'female' : null);
            const d = parseInt($('#insured_dob_d').value||'', 10);
            const m = parseInt($('#insured_dob_m').value||'', 10);
            const y = parseInt($('#insured_dob_y').value||'', 10);
            if (!plan || !sexMF || !d || !m || !y || !Number.isFinite(sa)) { state.quote = null; renderQuote(); updateNextState(); return; }
            const age = computeAgeFromDOB(d,m,y);
            const breakdown = computeAnnualPremium(plan, sexMF, age, sa);
            const quote = {
              age,
              baseRate: breakdown.baseRate,
              rateEff: breakdown.rateEff,
              annual: breakdown.annual,
              calculatedAt: new Date().toISOString(),
              datasetVersion: state.dataset?.fileInfo?.version || ''
            };
            state.quote = quote;
            renderQuote({ plan, sa, quote });
            updateNextState();
          } catch (e) {
            state.quote = null;
            renderQuote({ error: e.message });
            updateNextState();
          }
        };
        const debouncedRecalc = debounce(recalc, 350);

        /* ---------- Build selects ---------- */
        // DOB selects
        (function buildDOB() {
          const dSel = $("#insured_dob_d");
          let dOps = ""; for (let i=1;i<=31;i++) dOps += `<option value="${i}">${i}</option>`; dSel.innerHTML = dOps;
          const mSel = $("#insured_dob_m");
          let mOps = ""; for (let i=1;i<=12;i++) mOps += `<option value="${i}">${i}</option>`; mSel.innerHTML = mOps;
          const ySel = $("#insured_dob_y");
          const now = new Date(); const thisY = now.getFullYear(); const minY = thisY - 70, maxY = thisY - 1; // อายุ 1–70 ปี
          let yOps = ""; for (let y = maxY; y >= minY; y--) yOps += `<option value="${y}">${y}</option>`; ySel.innerHTML = yOps;
          // trigger recalc when DOB changes
          [dSel, mSel, ySel].forEach(el => el.addEventListener('change', debouncedRecalc));
        })();

        // Plans dropdown
        (function buildPlans() {
          const el = $("#plan_code");
          el.insertAdjacentHTML("beforeend", '<option value="" selected disabled>เลือกแบบประกัน</option>');
          PLANS.forEach((p) =>
            el.insertAdjacentHTML("beforeend", `<option value="${p.code}">${p.name}</option>`)
          );
          el.addEventListener("change", async () => {
            const sel = PLANS.find((p) => p.code === el.value);
            $("#plan_name").value = sel ? sel.name : "";
            $("#plan-note").textContent = sel?.note || "";
            try { await ensureDataset(); const plan = state.plansByKey.get(el.value); updatePlanUI(plan); } catch {}
            updatePreview();
            debouncedRecalc();
          });
        })();

        // Riders dropdowns
        const buildOptions = (el, arr) => {
          el.innerHTML = "";
          arr.forEach((v) =>
            el.insertAdjacentHTML(
              "beforeend",
              `<option value="${v}">${v || "ไม่เลือก"}</option>`
            )
          );
        };
        buildOptions($("#rider_hsa_cover"), RIDER_HSA);
        buildOptions($("#rider_hb_cover"), RIDER_HB);
        buildOptions($("#rider_opd_cover"), RIDER_OPD);
        buildOptions($("#rider_lt_term"), RIDER_LT);

        /* ---------- Gender segmented ---------- */
        $$(".gender-btn").forEach((btn) =>
          btn.addEventListener("click", () => {
            $("#insured_gender").value = btn.dataset.gender;
            toggleButtons($$(".gender-btn"), btn.dataset.gender);
            updatePreview();
            debouncedRecalc();
          })
        );
            const ok = res.ok && data.ok !== false;
            if (!ok) throw new Error(data.message || "Submit failed");
            state.submitted = true;
            $("#success-email").textContent = payload?.insured?.email || "";
            $("#success-lead").textContent = data?.lead?.id || "-";
            $$(".step").forEach((s) => s.classList.add("hidden"));
            $("#step-success").classList.remove("hidden");
            setProgress();
            document.querySelector("footer")?.classList.add("hidden");
          } catch (e) {
            alert(
              "ส่งข้อมูลไม่สำเร็จ: " + (e.message || "กรุณาลองใหม่อีกครั้ง")
            );
            console.error(e);
          } finally {
            state.submitting = false;
            if (!state.submitted) {
              $("#btn-submit").disabled = false;
              $("#btn-submit").textContent = "ขอใบเสนอราคา";
            } else {
              $("#btn-submit").disabled = true;
            }
          }
        });

        // Hash router
        window.addEventListener("hashchange", () => {
          const m = location.hash.match(/#\/step\/(\d+)/);
          if (m) showStep(parseInt(m[1], 10));
        });
        const m0 = location.hash.match(/#\/step\/(\d+)/);
        showStep(m0 ? parseInt(m0[1], 10) : 1);
      })();
    </script>
  </body>
</html>
