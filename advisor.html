<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ | Phillip Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: {
                DEFAULT: "#111827",
                50: "#f8fafc",
                100: "#f1f5f9",
                200: "#e2e8f0",
                300: "#cbd5e1",
                400: "#94a3b8",
                500: "#64748b",
                600: "#475569",
                700: "#334155",
                800: "#1f2937",
                900: "#111827",
              },
            },
          },
        },
      };
    </script>
    <style>
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
    </style>
  </head>
  <body class="bg-brand-50 text-brand-900">
    <header class="max-w-xl mx-auto px-4 pt-6 pb-2">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 rounded-2xl bg-brand-900 text-white grid place-items-center font-semibold"
        >
          PA
        </div>
        <div>
          <h1 class="text-lg font-semibold">‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h1>
          <p class="text-sm text-brand-600">Card Form ‚Ä¢ Mobile-first ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</p>
        </div>
        <div class="ml-auto text-xs text-brand-500" id="ref-badge" hidden></div>
      </div>
    </header>

    <!-- Progress (5 steps) -->
    <div class="max-w-xl mx-auto px-4">
      <div class="w-full bg-brand-200 rounded-full h-2 overflow-hidden">
        <div id="progress" class="h-2 bg-brand-900 w-1/5 transition-all"></div>
      </div>
      <div class="flex justify-between text-[11px] text-brand-600 mt-1">
        <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
      </div>
    </div>

    <main class="max-w-xl mx-auto px-4 py-4">
      <!-- STEP 1: Gender -->
      <section id="step-1" data-step="1" class="step">
        <div class="bg-white border border-brand-200 rounded-2xl p-5">
          <h2 class="text-base font-semibold mb-3">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏®‡πÉ‡∏î</h2>
          <div
            class="grid grid-cols-2 gap-2"
            role="group"
            aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®"
          >
            <button
              type="button"
              data-gender="M"
              class="gender-btn py-3 rounded-xl border border-brand-300 bg-white"
            >
              ‡∏ä‡∏≤‡∏¢
            </button>
            <button
              type="button"
              data-gender="F"
              class="gender-btn py-3 rounded-xl border border-brand-300 bg-white"
            >
              ‡∏´‡∏ç‡∏¥‡∏á
            </button>
          </div>
          <input type="hidden" id="insured_gender" name="insured.gender" />
          <p id="err-gender" class="text-xs text-red-600 mt-2 hidden">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®
          </p>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- STEP 2: DOB -->
      <section id="step-2" data-step="2" class="step hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5">
          <h2 class="text-base font-semibold mb-3">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏Ñ.‡∏®.)</h2>
          <div class="grid grid-cols-3 gap-2">
            <select
              id="insured_dob_d"
              name="insured.dob.d"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            ></select>
            <select
              id="insured_dob_m"
              name="insured.dob.m"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            ></select>
            <select
              id="insured_dob_y"
              name="insured.dob.y"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            ></select>
          </div>
          <p class="text-xs text-brand-500 mt-2">‡πÉ‡∏ä‡πâ‡∏õ‡∏µ <b>‡∏Ñ.‡∏®.</b> ‡πÄ‡∏ä‡πà‡∏ô 1992</p>
          <p id="err-dob" class="text-xs text-red-600 mt-2 hidden">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
          </p>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- STEP 3: Plan dropdown (limited set) -->
      <section id="step-3" data-step="3" class="step hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5">
          <h2 class="text-base font-semibold mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</h2>
          <select
            id="plan_code"
            name="plan.code"
            class="w-full rounded-xl border border-brand-300 p-3 bg-white"
          ></select>
          <input id="plan_name" name="plan.name" type="hidden" />
          <p id="plan-note" class="text-xs text-brand-500 mt-2"></p>
          <p id="err-plan" class="text-xs text-red-600 mt-2 hidden">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô
          </p>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- STEP 4: Sum Assured + Riders -->
      <section id="step-4" data-step="4" class="step hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5 space-y-4">
          <div>
            <h2 class="text-base font-semibold mb-3">
              ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏≠‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)
            </h2>
            <div class="flex gap-2 mb-2">
              <button
                type="button"
                data-sa="300000"
                class="sa-chip px-3 py-2 rounded-full border border-brand-300 bg-white text-sm"
              >
                300,000
              </button>
              <button
                type="button"
                data-sa="500000"
                class="sa-chip px-3 py-2 rounded-full border border-brand-300 bg-white text-sm"
              >
                500,000
              </button>
              <button
                type="button"
                data-sa="1000000"
                class="sa-chip px-3 py-2 rounded-full border border-brand-300 bg-white text-sm"
              >
                1,000,000
              </button>
            </div>
            <input
              id="plan_sumAssured"
              name="plan.sumAssured"
              inputmode="numeric"
              pattern="[0-9]*"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 1000000"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            />
            <p id="err-sa" class="text-xs text-red-600 mt-2 hidden">
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏∏‡∏ô‡πÄ‡∏≠‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô
            </p>
          </div>

          <div>
            <h3 class="text-sm font-semibold mb-2">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
            <!-- ADB toggle (mirrors SA) -->
            <div
              class="flex items-center justify-between rounded-xl border border-brand-300 bg-white p-3 mb-2"
            >
              <div>
                <div class="text-sm font-medium">ADB (‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏)</div>
                <div id="adb-hint" class="text-xs text-brand-500">‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div>
              </div>
              <button
                type="button"
                id="adb_toggle"
                class="px-3 py-2 rounded-full border border-brand-300 bg-white text-sm"
              >
                ‡πÄ‡∏õ‡∏¥‡∏î
              </button>
              <input
                id="rider_adb_cover"
                name="rider.adb.cover"
                type="hidden"
              />
            </div>

            <!-- Other riders as dropdowns (byText) -->
            <label class="block text-xs mb-1">HSA ‚Äì ‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á/‡∏ß‡∏±‡∏ô</label>
            <select
              id="rider_hsa_cover"
              name="rider.hsa.cover"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white mb-3"
            ></select>

            <label class="block text-xs mb-1">HB ‚Äì ‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡∏î‡πÄ‡∏ä‡∏¢/‡∏ß‡∏±‡∏ô</label>
            <select
              id="rider_hb_cover"
              name="rider.hb.cover"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white mb-3"
            ></select>

            <label class="block text-xs mb-1">OPD ‚Äì ‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</label>
            <select
              id="rider_opd_cover"
              name="rider.opd.cover"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white mb-3"
            ></select>

            <label class="block text-xs mb-1">LT ‚Äì ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
            <select
              id="rider_lt_term"
              name="rider.lt.term"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            ></select>
          </div>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- STEP 5: Email + PDPA -->
      <section id="step-5" data-step="5" class="step hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5">
          <h2 class="text-base font-semibold mb-3">‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</h2>
          <div class="grid grid-cols-2 gap-2 mb-3">
            <div>
              <label class="block text-sm mb-2">‡∏ä‡∏∑‡πà‡∏≠ (‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡∏ô)</label>
              <input
                id="insured_firstName"
                name="insured.firstName"
                class="w-full rounded-xl border border-brand-300 p-3 bg-white"
              />
            </div>
            <div>
              <label class="block text-sm mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡∏ô)</label>
              <input
                id="insured_lastName"
                name="insured.lastName"
                class="w-full rounded-xl border border-brand-300 p-3 bg-white"
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="block text-sm mb-2"
              >‡∏≠‡∏µ‡πÄ‡∏°‡∏• <span class="text-red-600">*</span></label
            >
            <input
              id="insured_email"
              name="insured.email"
              type="email"
              placeholder="you@example.com"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            />
            <p id="err-email" class="text-xs text-red-600 mt-1 hidden">
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            </p>
          </div>
          <div class="mb-3">
            <label class="block text-sm mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡∏ô)</label>
            <input
              id="insured_phone"
              name="insured.phone"
              inputmode="tel"
              placeholder="0812345678"
              class="w-full rounded-xl border border-brand-300 p-3 bg-white"
            />
          </div>

          <input id="agent_ref" name="source.ref" type="hidden" />
          <input
            id="mode_option"
            name="mode.option"
            type="hidden"
            value="‡∏£‡∏≤‡∏¢‡∏õ‡∏µ"
          />

          <div class="mb-3 flex items-start gap-2">
            <input
              id="consent_pdpa"
              name="consent.pdpa"
              type="checkbox"
              class="mt-1"
            />
            <label for="consent_pdpa" class="text-sm"
              >‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏µ‡πâ‡∏¢/‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
              ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö ‡∏ï‡∏≤‡∏°
              <a href="#" class="underline">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a></label
            >
          </div>
          <p id="err-pdpa" class="text-xs text-red-600 mt-1 hidden">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° PDPA ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
          </p>

          <!-- Preview JSON (hidden by default; open with ?debug=1) -->
          <details
            id="preview-box"
            class="bg-white border border-brand-200 rounded-xl p-3 mt-3"
            hidden
          >
            <summary class="cursor-pointer text-sm">
              ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á (Preview JSON)
            </summary>
            <pre id="preview" class="text-xs mt-2 whitespace-pre-wrap"></pre>
          </details>
        </div>
        <div class="h-16"></div>
      </section>

      <!-- Success screen -->
      <section id="step-success" class="hidden">
        <div class="bg-white border border-brand-200 rounded-2xl p-5">
          <h3 class="text-lg font-semibold mb-1">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ</h3>
          <p class="text-sm text-brand-600">
            ‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà
            <span id="success-email" class="font-medium"></span>
          </p>
          <p class="text-sm text-brand-600 mt-2">
            ‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: <span id="success-lead" class="font-mono"></span>
          </p>
        </div>
      </section>
    </main>

    <!-- Sticky footer nav -->
    <footer
      class="fixed bottom-0 inset-x-0 bg-white border-t border-brand-200 pb-safe"
    >
      <div class="max-w-xl mx-auto px-4 py-3 flex gap-2">
        <button
          id="btn-back"
          class="flex-1 py-3 rounded-xl border border-brand-300 text-brand-800 bg-white"
        >
          ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
        </button>
        <button
          id="btn-next"
          class="flex-1 py-3 rounded-xl bg-brand-900 text-white"
        >
          ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        </button>
        <button
          id="btn-submit"
          class="hidden flex-1 py-3 rounded-xl bg-brand-900 text-white"
        >
          ‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
        </button>
      </div>
    </footer>

    <script>
      (() => {
        /* ---------- Config ---------- */
        const WEBHOOK_URL =
          "https://script.google.com/macros/s/AKfycbw1DOFzsYQTa-J_SQwD_HvLxaf0wsfuGzn1lQ6rdKueEMG3xiBef_HpCRiuL3tEPxkEfw/exec"; // TODO: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°
        const PLANS = [
          {
            code: "PLA_20_10",
            name: "Happy Protect 20/10",
            note: "‡∏≠‡∏≠‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á 20 ‡∏õ‡∏µ ‡∏à‡πà‡∏≤‡∏¢ 10 ‡∏õ‡∏µ",
          },
          {
            code: "PLA_15_10",
            name: "Happy Protect 15/10",
            note: "‡∏≠‡∏≠‡∏°‡∏Å‡∏•‡∏≤‡∏á-‡∏¢‡∏≤‡∏ß ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á 15 ‡∏õ‡∏µ ‡∏à‡πà‡∏≤‡∏¢ 10 ‡∏õ‡∏µ",
          },
          {
            code: "PRO_10_5",
            name: "Pro Saving 10/5",
            note: "‡πÄ‡∏£‡πà‡∏á‡∏≠‡∏≠‡∏° ‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á 10 ‡∏õ‡∏µ ‡∏à‡πà‡∏≤‡∏¢ 5 ‡∏õ‡∏µ",
          },
          {
            code: "RET_60",
            name: "‡∏ö‡∏≥‡∏ô‡∏≤‡∏ç‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì 60",
            note: "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì ‡∏£‡∏±‡∏ö‡∏ö‡∏≥‡∏ô‡∏≤‡∏ç‡∏≠‡∏≤‡∏¢‡∏∏ 60",
          },
          {
            code: "LIFE_TERM",
            name: "Life Term 20",
            note: "‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î",
          },
        ];
        const RIDER_HSA = ["", "1500/‡∏ß‡∏±‡∏ô", "2000/‡∏ß‡∏±‡∏ô", "3000/‡∏ß‡∏±‡∏ô"];
        const RIDER_HB = ["", "500/‡∏ß‡∏±‡∏ô", "1000/‡∏ß‡∏±‡∏ô", "1500/‡∏ß‡∏±‡∏ô"];
        const RIDER_OPD = ["", "500/‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "1000/‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "1500/‡∏Ñ‡∏£‡∏±‡πâ‡∏á"];
        const RIDER_LT = ["", "10 ‡∏õ‡∏µ", "15 ‡∏õ‡∏µ", "20 ‡∏õ‡∏µ"];

        /* ---------- DOM helpers ---------- */
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => [...document.querySelectorAll(sel)];
        const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
        const isEmail = (s) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s || "");
        const qs = new URLSearchParams(location.search);
        const safeRef = (s) =>
          (s || "").match(/^[A-Za-z0-9_-]{1,24}$/) ? s : "";
        const formatTHB = (n) => (Number(n) || 0).toLocaleString("th-TH");

        /* ---------- State ---------- */
        const state = { step: 1, maxStep: 5, adbOn: false };

        const setProgress = () => {
          $("#progress").style.width = (state.step / state.maxStep) * 100 + "%";
          $("#btn-back").classList.toggle("hidden", state.step === 1);
          $("#btn-next").classList.toggle(
            "hidden",
            state.step === state.maxStep
          );
          $("#btn-submit").classList.toggle(
            "hidden",
            state.step !== state.maxStep
          );
        };
        const showStep = (i) => {
          state.step = clamp(i, 1, state.maxStep);
          $$(".step").forEach((s) => s.classList.add("hidden"));
          $(`#step-${state.step}`).classList.remove("hidden");
          $("#step-success").classList.add("hidden");
          setProgress();
          location.hash = "#/step/" + state.step;
          updatePreview();
        };

        const toggleButtons = (els, activeValue) => {
          els.forEach((btn) => {
            const on = btn.dataset.gender === activeValue;
            btn.classList.toggle("bg-brand-900", on);
            btn.classList.toggle("text-white", on);
            btn.classList.toggle("border-brand-900", on);
            btn.classList.toggle("bg-white", !on);
            btn.classList.toggle("text-brand-900", !on);
          });
        };

        const setVal = (sel, val) => {
          const el = $(sel);
          if (el) el.value = val;
        };

        /* ---------- Build selects ---------- */
        // DOB selects
        (function buildDOB() {
          const dSel = $("#insured_dob_d");
          for (let i = 1; i <= 31; i++)
            dSel.insertAdjacentHTML(
              "beforeend",
              `<option value="${i}">${i}</option>`
            );
          const mSel = $("#insured_dob_m");
          for (let i = 1; i <= 12; i++)
            mSel.insertAdjacentHTML(
              "beforeend",
              `<option value="${i}">${i}</option>`
            );
          const ySel = $("#insured_dob_y");
          const now = new Date();
          const thisY = now.getFullYear();
          const minY = thisY - 70,
            maxY = thisY - 1; // ‡∏≠‡∏≤‡∏¢‡∏∏ 1‚Äì70 ‡∏õ‡∏µ
          for (let y = maxY; y >= minY; y--)
            ySel.insertAdjacentHTML(
              "beforeend",
              `<option value="${y}">${y}</option>`
            );
        })();

        // Plans dropdown
        (function buildPlans() {
          const el = $("#plan_code");
          el.insertAdjacentHTML(
            "beforeend",
            '<option value="" selected disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</option>'
          );
          PLANS.forEach((p) =>
            el.insertAdjacentHTML(
              "beforeend",
              `<option value="${p.code}">${p.name}</option>`
            )
          );
          el.addEventListener("change", () => {
            const sel = PLANS.find((p) => p.code === el.value);
            $("#plan_name").value = sel ? sel.name : "";
            $("#plan-note").textContent = sel?.note || "";
            updatePreview();
          });
        })();

        // Riders dropdowns
        const buildOptions = (el, arr) => {
          el.innerHTML = "";
          arr.forEach((v) =>
            el.insertAdjacentHTML(
              "beforeend",
              `<option value="${v}">${v || "‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"}</option>`
            )
          );
        };
        buildOptions($("#rider_hsa_cover"), RIDER_HSA);
        buildOptions($("#rider_hb_cover"), RIDER_HB);
        buildOptions($("#rider_opd_cover"), RIDER_OPD);
        buildOptions($("#rider_lt_term"), RIDER_LT);

        /* ---------- Gender segmented ---------- */
        $$(".gender-btn").forEach((btn) =>
          btn.addEventListener("click", () => {
            $("#insured_gender").value = btn.dataset.gender;
            toggleButtons($$(".gender-btn"), btn.dataset.gender);
            updatePreview();
          })
        );

        /* ---------- SA chips ---------- */
        $$(".sa-chip").forEach((ch) =>
          ch.addEventListener("click", () => {
            $("#plan_sumAssured").value = ch.dataset.sa;
            syncADBwithSA();
            updatePreview();
          })
        );
        $("#plan_sumAssured").addEventListener("input", () => {
          syncADBwithSA();
          updatePreview();
        });

        /* ---------- ADB toggle mirrors SA ---------- */
        const setADBHints = () => {
          const sa = Number($("#plan_sumAssured").value || 0);
          if (state.adbOn) {
            $("#adb-hint").textContent = `‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‚Ä¢ ‡∏ó‡∏∏‡∏ô ADB = ${formatTHB(
              sa
            )} ‡∏ö‡∏≤‡∏ó`;
            $("#adb_toggle").textContent = "‡∏õ‡∏¥‡∏î";
          } else {
            $("#adb-hint").textContent = "‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà";
            $("#adb_toggle").textContent = "‡πÄ‡∏õ‡∏¥‡∏î";
          }
        };
        const syncADBwithSA = () => {
          if (state.adbOn) {
            const sa = $("#plan_sumAssured").value.trim();
            $("#rider_adb_cover").value = sa || "";
            setADBHints();
          }
        };
        $("#adb_toggle").addEventListener("click", () => {
          state.adbOn = !state.adbOn;
          if (state.adbOn) {
            $("#rider_adb_cover").value = $("#plan_sumAssured").value.trim();
          } else {
            $("#rider_adb_cover").value = "";
          }
          setADBHints();
          updatePreview();
        });

        /* ---------- Collect payload ---------- */
        const collectPayload = () => {
          const data = {};
          $$("input[name], select[name], textarea[name]").forEach((el) => {
            const path = el.name;
            if (!path) return;
            let value = el.type === "checkbox" ? !!el.checked : el.value;
            if (String(value).trim() === "") return; // skip empty optional
            if (path.startsWith("rider.") && value === "") return; // skip rider not selected
            const keys = path.split(".");
            let cur = data;
            keys.forEach((k, i) => {
              if (i === keys.length - 1) cur[k] = value;
              else cur = cur[k] = cur[k] || {};
            });
          });

          // copy utm_* from URL
          const utm = {};
          for (const [k, v] of qs.entries())
            if (k.startsWith("utm_")) utm[k] = v;
          if (Object.keys(utm).length)
            data.source = Object.assign({}, data.source, utm);
          return data;
        };

        const updatePreview = () => {
          const payload = collectPayload();
          const box = $("#preview-box");
          $("#preview").textContent = JSON.stringify(payload, null, 2);
          if (qs.get("debug") === "1") box.hidden = false; // show only in debug
        };

        /* ---------- Validation per step ---------- */
        const validateStep1 = () => {
          const ok = !!$("#insured_gender").value;
          $("#err-gender").classList.toggle("hidden", ok);
          return ok;
        };
        const validateStep2 = () => {
          const d = $("#insured_dob_d").value,
            m = $("#insured_dob_m").value,
            y = $("#insured_dob_y").value;
          const ok = !!(d && m && y);
          $("#err-dob").classList.toggle("hidden", ok);
          return ok;
        };
        const validateStep3 = () => {
          const ok = !!$("#plan_code").value;
          $("#err-plan").classList.toggle("hidden", ok);
          return ok;
        };
        const validateStep4 = () => {
          const sa = $("#plan_sumAssured").value.trim();
          const ok = /^[0-9]+$/.test(sa);
          $("#err-sa").classList.toggle("hidden", ok);
          return ok;
        };
        const validateStep5 = () => {
          const email = $("#insured_email").value.trim();
          const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
          $("#err-email").classList.toggle("hidden", emailOk);
          const pdpaOk = $("#consent_pdpa").checked;
          $("#err-pdpa").classList.toggle("hidden", pdpaOk);
          return emailOk && pdpaOk;
        };

        /* ---------- Navigation ---------- */
        $("#btn-next").addEventListener("click", () => {
          if (state.step === 1 && !validateStep1()) return;
          if (state.step === 2 && !validateStep2()) return;
          if (state.step === 3 && !validateStep3()) return;
          if (state.step === 4 && !validateStep4()) return;
          showStep(state.step + 1);
        });
        $("#btn-back").addEventListener("click", () =>
          showStep(state.step - 1)
        );

        $$("input[name], select[name]").forEach((el) =>
          el.addEventListener("input", updatePreview)
        );

        /* ---------- Referral + Prefill ---------- */
        (function prefill() {
          // referral id
          const ref =
            safeRef(qs.get("ref")) || localStorage.getItem("lead.ref") || "";
          if (ref) {
            $("#agent_ref").value = ref;
            $("#ref-badge").textContent = "REF: " + ref;
            $("#ref-badge").hidden = false;
            try {
              localStorage.setItem("lead.ref", ref);
            } catch {}
          }

          // plan
          const planCodeQS = qs.get("plan.code");
          const planNameQS = qs.get("plan.name");
          const planSel = $("#plan_code");
          if (planCodeQS && PLANS.some((p) => p.code === planCodeQS)) {
            planSel.value = planCodeQS;
            planSel.dispatchEvent(new Event("change"));
          } else if (planNameQS) {
            const hit = PLANS.find((p) => p.name === planNameQS);
            if (hit) {
              planSel.value = hit.code;
              planSel.dispatchEvent(new Event("change"));
            }
          }

          if (qs.get("sa")) $("#plan_sumAssured").value = qs.get("sa");
          if (qs.get("gender")) {
            $("#insured_gender").value = qs.get("gender");
            toggleButtons($$(".gender-btn"), qs.get("gender"));
          }
          if (qs.get("dob")) {
            const m = (qs.get("dob") || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (m) {
              setVal("#insured_dob_y", m[1]);
              setVal("#insured_dob_m", String(parseInt(m[2], 10)));
              setVal("#insured_dob_d", String(parseInt(m[3], 10)));
            }
          }

          updatePreview();
          setADBHints();
        })();

        /* ---------- Submit ---------- */
        $("#btn-submit").addEventListener("click", async () => {
          if (!validateStep5()) return;
          const payload = collectPayload();
          payload.source = Object.assign({}, payload.source, {
            page: "lead-capture",
            userAgent: navigator.userAgent,
          });

          $("#btn-submit").disabled = true;
          $("#btn-submit").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
          try {
            const res = await fetch(WEBHOOK_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const data = await res.json().catch(() => ({}));
            const ok = res.ok && data.ok !== false;
            if (!ok) throw new Error(data.message || "Submit failed");
            $("#success-email").textContent = payload?.insured?.email || "";
            $("#success-lead").textContent = data?.lead?.id || "-";
            $$(".step").forEach((s) => s.classList.add("hidden"));
            $("#step-success").classList.remove("hidden");
            setProgress();
          } catch (e) {
            alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
            console.error(e);
          } finally {
            $("#btn-submit").disabled = false;
            $("#btn-submit").textContent = "‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤";
          }
        });

        // Hash router
        window.addEventListener("hashchange", () => {
          const m = location.hash.match(/#\/step\/(\d+)/);
          if (m) showStep(parseInt(m[1], 10));
        });
        const m0 = location.hash.match(/#\/step\/(\d+)/);
        showStep(m0 ? parseInt(m0[1], 10) : 1);
      })();
    </script>
  </body>
</html>
